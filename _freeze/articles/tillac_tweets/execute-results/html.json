{
  "hash": "03d2182613c8b93bec5456e810df2b60",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Search your tweets with an automatic pipeline\ndate: \"2020-07-08\"\ndescription: \"Use Github Actions as an orchestrator tool to print your tweets on a table\"\ncategories: [Blog]\nimage: \"\"\ndraft: true\nexecute: \n  eval: false\n---\n\n\n\n> Note: this blog post is an archive that isn't alive anymore (I only cleaned the content). However it's still useful when you need to setup Github Actions workflows.\n\n## Why do I need a search engine for my tweets ?\n\nTwitter is a fantastic tool if you are involved in the R community or simply interested by R and other subjects around statistics, design or data science. A lot of nice people are tweeting their work and insights. You can have a look at Oscar Baruffa and Veerle van Son work on it : [https://www.t4rstats.com/](https://www.t4rstats.com/).\n\nI like it a lot and I mark all the good tweets I see as \"favorites\" because I don't have time to read them on the moment or because I want to keep track of them for later, when I will have to answer some questions or point at a good resource.\n\nBut the difficulties come after, when I when to search back into the tweets I liked. I have to scroll a lot in my profile page and click to see more tweets. That's harassing. So I design a little tool that could help my search inside my own tweets : [Morphea](https://morphea.netlify.app/) - [Github](https://github.com/tillac/morphea).\n\nThe name come from Morpheus, the greek God of sleep, called \"MorphÃ©e\" in French. I named it so because it has to run when I sleep.\n\nI wrote it as a big `reactable` [table](https://glin.github.io/reactable/index.html) which is feed by an automatic pipeline using `rtweet` for [tweet collection](https://rtweet.info/) and [Github Actions](https://docs.github.com/en/actions).\n\nThis blog post aims at presenting the internals of this application. This one fits my needs and how I use it. Feel free to fork it and adapt it to yours. The full repo is available on [Github](https://github.com/tillac/morphea).\n\n## Pipeline\n\nMy pipeline runs on Github Actions with the following steps :\n\n+ Collect tweets from Twitter using `rtweet` ;\n+ Wrangle data and store them on a Google Sheet with `googlesheets4`. This step isn't mandatory but I want to be able to manually annotate things here. You can skip it if you want something simplier ;\n+ Take the data from the Sheet and build a table with `reactable` inside an `rmarkdown::html_document` with some CSS flavour ;\n+ Publish on Netlify.\n\nThis graphic summarize it : \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(DiagrammeR)\n\ngrViz(\n  \"\ndigraph pipeline {\n\n  graph [overlap = true, \n          fontsize = 10, \n          fontname = Lato, \n          color = '#000000', \n          penwidth = 4]\n\n  # nodes\n  node [shape = circle, penwidth = 2, color = '#d3d3d3', style = filled]\n\n    twitter [label = 'Twitter', fillcolor = '#00acee', fontcolor = '#ffffff']\n    sheets [label = 'Google \\nSheets', fillcolor = '#0f9d58', fontcolor = '#ffffff']\n    netlify [label = 'Netlify', fillcolor = '#25c7b7', fontcolor = '#ffffff']\n    artifact [label = 'Artifact \\nGithub', fillcolor = '#000000', fontcolor = '#ffffff']\n\n    subgraph cluster_github {\n     node [shape = square]\n      collecting [label = 'Collect tweets']\n      table [label = 'Render table']\n   }\n\n  # edges\n  twitter -> collecting -> sheets -> table \n  table -> netlify\n  table -> artifact\n\n}\n      \")\n```\n:::\n\n\n\n### Managing the pipeline with Github Actions\n\nThe core program of the pipeline is a [YAML file](https://github.com/tillac/morphea/blob/master/.github/workflows/collect_tw_table.yaml) used by Github to run Actions. I will comment it here.\n\nThe Actions execute itself on three conditions :\n\n+ when I push to master ;\n+ every Monday at 12 ;\n+ every Thursday at 12.\n\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\nname: Collecting tweets and render table\non:\n  push:\n    branches:\n      - master\n  schedule:\n    - cron: '0 12 * * 1'\n    - cron: '0 12 * * 4'\n```\n:::\n\n\n\nI run my tasks on a [Rocker container](https://hub.docker.com/r/rocker/verse) called `verse`. It contains all of the `tidyverse` and elements to run `rmarkdown`. [Rocker](https://www.rocker-project.org/) is a project of Docker container with R and other useful packages installed. I rely heavily on this when using Github Actions.\n\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\njobs:\n  collect:\n    name: Collect tweets and render\n    runs-on: ubuntu-latest\n    container: rocker/verse\n```\n:::\n\n\n\nThe next big step is to call of the secrets and set them as environment variables. I can after that use them with `Sys.getenv(\"TW_API_KEY\")` as an example.\n\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\n    env:\n      TW_API_KEY: ${{ secrets.TW_API_KEY }}\n      TW_SECRET_KEY: ${{ secrets.TW_SECRET_KEY }}\n      TW_ACCESS_TOKEN: ${{ secrets.TW_ACCESS_TOKEN }}\n      TW_SECRET_TOKEN: ${{ secrets.TW_SECRET_TOKEN }}\n      SHEET_PATH: ${{ secrets.SHEET_PATH }}\n      GOOGLE_MAIL: ${{ secrets.GOOGLE_MAIL }}\n      GOOGLE_TOKEN: ${{ secrets.GOOGLE_TOKEN }}\n```\n:::\n\n\n\nI checkout into my repo and decrypt the Google token. I also install all my needed dependencies. Note that `remotes` is installed in `rocker/verse` so I don't need to install it. It's also the case for `tidyverse` and other packages I use.\n\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\n    steps:\n      - uses: actions/checkout@v2\n      \n      - name: Decrypt large secret\n        run: ./secret/decrypt_secret.sh\n        env:\n          LARGE_SECRET_PASSPHRASE: ${{ secrets.LARGE_SECRET_PASSPHRASE }}\n      \n      - name: Install dependencies\n        run: |\n          remotes::install_cran(\"rtweet\")\n          remotes::install_cran(\"googlesheets4\")\n          remotes::install_cran(\"reactable\")\n          remotes::install_github(\"ropenscilabs/icon\")\n        shell: Rscript {0}\n```\n:::\n\n\n\nI run my collecting script. The results are stored as an artifact in case I want to have a look at them and check is everything goes fine.\n\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\n      - name: Run collecting script\n        run: |-\n          Rscript R/collecting_likes.R\n          \n      - name: Save result as artifact\n        uses: actions/upload-artifact@v1\n        with:\n          name: tw_table\n          path: tw_fav.csv\n```\n:::\n\n\n\nI render the page with the table. You can merge this step with the previous one if you don't want an intermediate storing in Sheets.\n\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\n      - name: Render table\n        run: |-\n          rmarkdown::render(\"Rmd/tw_table.Rmd\", output_file = \"index.html\", output_dir = \".\")\n        shell: Rscript {0}\n```\n:::\n\n\n\nAnd I deploy to Netlify. We need to install `npm` just before.\n\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\n      - name: Install npm\n        uses: actions/setup-node@v1\n\n      - name: Deploy to Netlify\n        env:\n          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}\n          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}\n        run: |\n          npm install netlify-cli -g\n          netlify deploy --prod --dir .  \n```\n:::\n\n\n\nIt's not really complicated but CI could be hard due to small things like spaces, indentation, storing secrets, checkout, etc. Just try a lot (see my [commit history](https://github.com/tillac/morphea/commits/master)).\n\n### Secrets everywhere\n\nThe big part in this pipeline is to manage all the keys and tokens. That was the most difficult part because you have to deal with many API. For that, I used the secrets in Github Settings. \n\n![](/img/posts/morphea/gha_secrets.png)\n\nI have 9 secrets here :\n\n+ 4 for Twitter API ;\n+ 3 for Google API (mail, path and the passphrase for the token) ;\n+ 2 for Netlify API.\n\nIf you don't use a Google Sheet step, you can have only 6.\n\nNote that once set, you can't access to the secret's value anymore. So if you forgot it (and need it), you can just generate a new token/key and copy-paste it here.\n\nJust configure each secret, as explain below (keep a local copy in a non-versioned file to test on your computer) and call them through environments variables (as in the YAML file above). You can use them after that in your R file. \n\n#### Twitter\n\nAll of the elements can be obtained through the `rtweet` vignette on [authentification](http://rtweet.info/articles/auth.html). Note that you will need a Developer Account here. It can take some days.\n\n#### Google\n\nHere, you will need three elements :\n\n+ GOOGLE_MAIL is just your mail ;\n+ SHEET_PATH is the path of you Google Sheet ;\n+ a Google Token.\n\nThe last one is obtained through this [procedure](https://gargle.r-lib.org/articles/get-api-credentials.html) in the `gargle` package (section \"Service account token\"), which underlies `googlesheets4`.\n\nI encrypt the token with a passphrase (with `gpg --symmetric --cipher-algo AES256 ./secret/morphea_token.json`) and store the encrypted version in a repo. The passphrase (LARGE_SECRET_PASSPHRASE) is store as a secret to decrypt the token and called in the pipeline. You can find more details :\n\n+ in the [code](https://github.com/tillac/morphea/blob/master/secret/decrypt_secret.sh) ;\n+ in the [documentation](https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets).\n\nThis is a standard procedure when storing token.\n\n#### Netlify\n\nFor Netlify, you will need an account. Create a new site and put the name you want (if available).\n\nIn \"Site Settings\" :\n\n+ Stop all the builds. You don't need to track them because you will push the site from Github (and not pulled it from Netlify as usual) ;\n+ You can find the API key in \"General\". It's called \"API ID\". I saved it as NETLIFY_SITE_ID ;\n+ You can fin the auth token (NETLIFY_AUTH_TOKEN) in \"User settings\" > \"Applications\" > \"New access token\" > \"Generate token\".\n\nIf needed, a more detailed [how-to](https://www.hvitfeldt.me/blog/bookdown-netlify-github-actions/) has been written by Emil Hvitfeldt.\n\n## The result\n\nAll of this results in a big table with approximately 1.000 tweets inside (50 per page), generated through `rmarkdown` for the document and `reactable` for the table itself. I recommend this awesome [package](https://glin.github.io/reactable/index.html) for creating interactive tables.\n\n![](/img/posts/morphea/morphea_screenshot.png)\n\nThe main functionalities are :\n\n+ embedding : thanks to Greg Lin, I have added a [Tweet Embedding](https://github.com/glin/reactable/issues/55). I moslty remind of things visually so it's very useful to me\n\n+ ordering : you can order any columns by date or alphabetical order\n\n+ filtering : you can filter the main column (Account, Text, Hashtags) to find tweets faster\n\n+ key metrics : I added two metrics about favourites and retweets number (in log here). The value print when you hover the bar\n\n+ link to main resources : you have a link to the tweet on the left (the anchor) and main urls in each tweet\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}